<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MARA Region Alert Map Test</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<!--Mapbox-->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" type="text/css">
<!--Mapbox Geocoder-->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
<!--Supabase JavaScript SDK-->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!--jQuery-->
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous">
</script>
<!--Magic iFrame-->
<script src="magic-iframe.min.js" data-role="child"></script>
<!--W3-->
<link rel="stylesheet" href="w3.css" type="text/css">
<style>
body { 
    margin: 0; 
    padding: 0; 
}
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
.mapboxgl-popup-content {
    box-shadow: 0 0 10px 2px rgba(0,0,0,.1);
    border-radius: .25rem;
}
.mapboxgl-popup-content a {
    outline: none;
    border: 0;
}
</style>
</head>
<body>

<div id="map"></div>

<script>
// Constants
const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoibWFyYS1hZG1pbiIsImEiOiJjbGQ5djVhc3QwOW03M25ucHZzeG92Z2kwIn0.TWD6NPNUnQ4CemIKMCKEpg';
const SUPABASE_URL = 'https://txtsljlkvthdlxjesaam.supabase.co';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4dHNsamxrdnRoZGx4amVzYWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODYyMDk0MjQsImV4cCI6MjAwMTc4NTQyNH0.Ej2zVnCif-7Xe6yQkFX9ln7L1yV7UB8xyZARD1ePQSE';

// Function to get region name from URL
function getRegionNameFromURL() {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    return urlParams.get('region') ? urlParams.get('region').split('-').join(' ') : 'world';
}

// Function to get location settings
function getLocationSettings(location) {
  const locationSettings = {
    'indian ocean': {
      style: 'mapbox://styles/mara-admin/cld9y9ky3003r01qrm5u614e8',
      center: [57.79394769437804, 14.82233465297636],
      zoom: 4
    },
    'west africa': {
      style: 'mapbox://styles/mara-admin/cldk38k54001y01oqwa51ub4e',
      center: [5.18485323153175, 1.0727315127537915],
      zoom: 4
    },
    'southeast asia': {
      style: 'mapbox://styles/mara-admin/cld9y9ky3003r01qrm5u614e8',
      center: [104.07224145349453, 1.3925672730413832],
      zoom: 4
    },
    'americas': {
      style: 'mapbox://styles/mara-admin/cld9y9ky3003r01qrm5u614e8',
      center: [-72.966695, 11.953412],
      zoom: 4
    },
    'europe': {
      style: 'mapbox://styles/mara-admin/cld9y9ky3003r01qrm5u614e8',
      center: [23.7015295592436, 38.03676783844519],
      zoom: 3.5
    },
    'default': {
      style: 'mapbox://styles/mara-admin/cld9y9ky3003r01qrm5u614e8',
      center: [0, 0],
      zoom: 1
    }
  };

  return locationSettings[location] || locationSettings['default'];
}

// Function to make the first letter of each word uppercase
function titleCase(str) {
        str = str.toLowerCase().split(' ').map(function(word) {
            return word.replace(word[0], word[0].toUpperCase());
        });
        return str.join(' ');
        }

// Function to add map layers
function addMapLayers(map) {
    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;

    map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'data',
        filter: ['has', 'point_count'],
        paint: {
            'circle-color': [
                'step',
                ['get', 'point_count'],
                '#a6a6a6', 20, '#828282', 40, '#5f5f60', 60, '#3f3f40', 100, '#212122'
            ],
            'circle-radius': [
                'step',
                ['get', 'point_count'],
                20, 20, 22, 40, 25, 60, 30, 100, 35
            ]
        }
    });

    map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'data',
        filter: ['has', 'point_count'],
        layout: {
            'text-field': '{point_count_abbreviated}',
            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
            'text-size': 12,
            'text-allow-overlap': true
        },
        paint: {
            'text-color': [
                'step',
                ['get', 'point_count'],
                '#000000', 60, '#ffffff'
            ]
        }
    });

    map.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'data',
        filter: ['!', ['has', 'point_count']],
        paint: {
            'circle-radius': {
                'base': 3.75,
                'stops': [
                    [4, 7],
                    [15, 90]
                ]
            },
            'circle-color': [
                'match',
                ['get', 'Type'],
                'Piracy', '#F82B60',
                'Sighting', '#FF6F2C',
                'Smuggling', '#20C933',
                'Suspicious Approach', '#FF6F2C',
                'Other', '#2D7FF9',
                'Military Action', '#F82B60',
                '#ff0000'
            ],
        }
    });

    // Add your existing event listeners here
    map.on('click', 'clusters', (e) => {
        // Handle cluster click
        // ...

        // Example: Show a popup on cluster click
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('data').getClusterExpansionZoom(clusterId, (err, zoom) => {
            if (err) return;
            map.flyTo({ center: features[0].geometry.coordinates, zoom: zoom });
        });
    });

    map.on('mouseenter', 'unclustered-point', (e) => {
        // Handle unclustered point mouseenter
        // ...

        // Example: Show a popup on unclustered point mouseenter
        const coordinates = e.features[0].geometry.coordinates.slice();
        // Create and display a popup with details
        const popup = new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML('<p>Popup content here</p>')
            .addTo(map);
    });

    map.on('mouseleave', 'unclustered-point', (e) => {
        // Handle unclustered point mouseleave
        // ...

        // Example: Close the popup on unclustered point mouseleave
        if (popup.isOpen()) {
            popup.remove();
        }
    });

    map.on('click', 'unclustered-point', (e) => {
        // Handle unclustered point click
        // ...

        // Example: Fly to the clicked point on unclustered point click
        const coordinates = e.features[0].geometry.coordinates.slice();
        map.flyTo({ center: coordinates, zoom: 8 });
    });
}

// Function to fetch data from Supabase and add it to the map
async function fetchDataAndAddToMap(map) {
    try {
        /*// Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_API_KEY, {
            db: { schema: 'airtable' }
        });

        // Function to fetch data from Supabase
        const { data, error } = await supabaseClient
            .from('incidents')
            .select('position, date, description, header, details_url_absolute, regions!inner(*), alert_types!inner(*)')
            .eq('regions.name', 'Indian Ocean');

        if (error) {
            console.error('Supabase error', error);
            return;
        }*/

        const response = await fetch(`${SUPABASE_URL}/rest/v1/incidents?select=position,date,description,header,details_url_absolute,regions(name),alert_types(name,color)`, {
            headers: {
                'apikey': SUPABASE_API_KEY,
                'Authorization': `Bearer ${SUPABASE_API_KEY}`,
                'Accept-Profile': 'airtable',
            },
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const data = await response.json();

        console.log('Supabase data', data);

        const geojsonFeatures = [];

        data.forEach((record) => {
            const itemLatLongsplit = record.position.split(",");
            if (record.position) {
                const description = record.description;
                const header = record.header;
                const url = record.details_url_absolute;

                geojsonFeatures.push({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(itemLatLongsplit[1]), parseFloat(itemLatLongsplit[0])]
                    },
                    properties: {
                        ID: record.id,
                        Header: header,
                        Date: record.date.substring(0, 10),
                        Longitude: parseFloat(itemLatLongsplit[1]),
                        Latitude: parseFloat(itemLatLongsplit[0]),
                        Description: description,
                        Type: record.type,
                        URL: url
                    }
                });
            }
        });

        console.log("geojsonFeatures: ", geojsonFeatures);

        const geojsonObject = {
            type: 'FeatureCollection',
            features: geojsonFeatures
        };

        map.addSource('data', {
            type: 'geojson',
            data: geojsonObject,
            cluster: true,
            generateId: true,
            clusterMaxZoom: 5,
            clusterRadius: 40
        });

        // Add map layers, interactions, and controls as before
        addMapLayers(map);
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}

// Function to set up map and event listeners
function setupMap() {
    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
    const regionName = getRegionNameFromURL();
    const regionSettings = getLocationSettings(regionName);

    const map = new mapboxgl.Map({
        container: 'map',
        style: regionSettings.style,
        center: regionSettings.center,
        zoom: regionSettings.zoom,
    });

    map.on('load', () => {
        // Add map layers, interactions, and controls
        addMapLayers(map);

        // Fetch data from Supabase and add it to the map
        fetchDataAndAddToMap(map);
    });
}

// Call setupMap to start the process
setupMap();

</script>

</body>
</html>