<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MARA Region Alert Map Test Refactored</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<!--Mapbox-->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" type="text/css">
<!--Mapbox Geocoder-->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
<!--Supabase JavaScript SDK-->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!--jQuery-->
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous">
</script>
<!--Magic iFrame-->
<script src="magic-iframe.min.js" data-role="child"></script>
<!--W3-->
<link rel="stylesheet" href="w3.css" type="text/css">
<style>
body { 
    margin: 0; 
    padding: 0; 
}
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
.mapboxgl-popup-content {
    box-shadow: 0 0 10px 2px rgba(0,0,0,.1);
    border-radius: .25rem;
}
.mapboxgl-popup-content a {
    outline: none;
    border: 0;
}
</style>
</head>
<body>

<div id="map"></div>

<script>
// Constants
const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoibWFyYS1hZG1pbiIsImEiOiJjbGQ5djVhc3QwOW03M25ucHZzeG92Z2kwIn0.TWD6NPNUnQ4CemIKMCKEpg';
const SUPABASE_URL = 'https://txtsljlkvthdlxjesaam.supabase.co';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4dHNsamxrdnRoZGx4amVzYWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODYyMDk0MjQsImV4cCI6MjAwMTc4NTQyNH0.Ej2zVnCif-7Xe6yQkFX9ln7L1yV7UB8xyZARD1ePQSE';

// Function to get region name from URL
function getRegionNameFromURL() {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    return urlParams.get('region') ? urlParams.get('region').split('-').join(' ') : 'world';
}

// Function to fetch region data from Supabase
async function fetchRegionData(regionName) {
    try {
        const { data, error } = await supabase
            .from('incidents')
            .select('region, regions!inner(*)')
            .eq('regions.name', regionName);
        if (error) console.log('Error fetching region data:', error);
        console.log('Region data:', data);
    } catch (error) {
        console.error('Error fetching region data:', error);
    }
}

// Function to get location settings
function getLocationSettings(location) {
    const locationSettings = {
        'indian ocean': {
            style: 'mapbox://styles/mara-admin/cld9y9ky3003r01qrm5u614e8',
            center: [57.79394769437804, 14.82233465297636],
            zoom: 4
        },
        // ... (add other locations here)
        'default': {
            style: 'mapbox://styles/mara-admin/cld9y9ky3003r01qrm5u614e8',
            center: [0, 0],
            zoom: 1
        }
    };

    return locationSettings[location] || locationSettings['default'];
}

// Function to add map layers
function addMapLayers(map) {
    // ... (your existing map layer code)
}

// Function to fetch data from Supabase and add it to the map
async function fetchDataAndAddToMap() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/incidents`, {
            headers: {
                'apikey': SUPABASE_API_KEY,
                'Authorization': `Bearer ${SUPABASE_API_KEY}`,
                'Accept-Profile': 'airtable',
            },
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const data = await response.json();
        console.log(data);

        // ... (your existing data processing code)

        // Add the retrieved data to the map
        // ... (your existing map data adding code)
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}

// Function to set up map and event listeners
function setupMap() {
    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
    const regionName = getRegionNameFromURL();
    const regionSettings = getLocationSettings(regionName);

    const map = new mapboxgl.Map({
        container: 'map',
        style: regionSettings.style,
        center: regionSettings.center,
        zoom: regionSettings.zoom,
    });

    // ... (your existing map setup code)

    // Load custom marker image
    map.loadImage('./mapbox-marker-icon-20px-purple.png', (error, image) => {
        if (error) throw error;
        map.addImage('marker', image, {});
        map.addImage('marker1', image, {});

        // Add map layers and fetch data from Supabase
        addMapLayers(map);
        fetchDataAndAddToMap();
    });
}

// Initialize Supabase client
const { createClient } = supabase;
let supabase = createClient(SUPABASE_URL, SUPABASE_API_KEY, {
    db: { schema: 'airtable' }
});

// Call setupMap to start the process
setupMap();

</script>

</body>
</html>